name: Build Legacy APK for Old Projector

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  build:
    name: Build APK (minSdk 19)
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. 安装指定版本 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml
          cache: true

      - name: 4. 应用底部弹窗补丁 (可选)
        working-directory: ${{ env.FLUTTER_ROOT }}
        run: git apply $GITHUB_WORKSPACE/lib/scripts/bottom_sheet_patch.diff
        continue-on-error: true

      - name: 5. 获取依赖 & 应用配置
        run: |
          flutter clean
          flutter pub get

      # ========== 新增的关键步骤 ==========
      - name: 5.5 优化Gradle配置并强制SDK版本
        run: |
          cd android
          cat > gradle.properties << 'EOF'
          # 核心：强制SDK版本以兼容老设备
          android.minSdkVersion=19
          android.targetSdkVersion=22
          android.compileSdkVersion=34
          
          # 启用AndroidX
          android.useAndroidX=true
          android.enableJetifier=true
          
          # ==== 内存与性能优化（解决GC Thrashing）====
          # 为Gradle守护进程分配更大内存
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          # 启用并行构建和配置缓存
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          # 启用Gradle守护进程（加快重复构建）
          org.gradle.daemon=true
          EOF
          echo "✅ 已配置优化后的gradle.properties（含大内存设置）"
      # ==================================
      - name: 5.6 【关键】强制覆盖所有插件的minSdk和targetSdk
        run: |
          echo "=== 开始扫描并覆盖所有插件中的SDK版本配置 ==="
          # 进入Android项目根目录
          cd android
          # 使用find命令定位所有build.gradle和build.gradle.kts文件（包括所有子模块、插件）
          # 并使用sed命令直接替换其中的minSdkVersion和targetSdkVersion值
          find . -type f -name "build.gradle*" \
            | xargs grep -l "minSdkVersion\|minSdk\|targetSdkVersion\|targetSdk" \
            | while read file; do
                echo "处理文件: $file"
                # 处理 minSdkVersion (支持各种写法)
                sed -i.bak -E "s/minSdkVersion\s*[0-9]+/minSdkVersion 19/g; s/minSdk\s*[0-9]+/minSdk 19/g" "$file"
                # 处理 targetSdkVersion (支持各种写法)
                sed -i.bak -E "s/targetSdkVersion\s*[0-9]+/targetSdkVersion 22/g; s/targetSdk\s*[0-9]+/targetSdk 22/g" "$file"
              done
          echo "=== 所有插件的SDK版本已强制覆盖为19/22 ==="
      - name: 5.7 【最终手段】直接修改合并后的AndroidManifest
        run: |
          echo "=== 开始查找并修改合并后的AndroidManifest文件 ==="
          # 进入Android项目目录
          cd android
          # 1. 首先，尝试在构建 intermediates 目录中查找合并后的清单文件
          # 它通常在 app/build/intermediates/merged_manifests/debug/AndroidManifest.xml 或类似路径
          # 由于路径可能变化，我们使用 find 命令定位
          MERGED_MANIFEST=$(find . -path "*/merged_manifests/*/AndroidManifest.xml" -type f | head -1)
          
          if [ -f "$MERGED_MANIFEST" ]; then
            echo "找到合并后的清单文件: $MERGED_MANIFEST"
            # 备份原文件
            cp "$MERGED_MANIFEST" "${MERGED_MANIFEST}.bak"
            # 使用sed删除或覆盖任何 <uses-sdk> 标签，替换为我们指定的版本
            sed -i '/<uses-sdk/,/\/>/d' "$MERGED_MANIFEST"
            # 在 <application> 标签前插入我们自己的 <uses-sdk> 定义
            sed -i 's/<application>/<uses-sdk android:minSdkVersion="19" android:targetSdkVersion="22" \/>\n<application>/' "$MERGED_MANIFEST"
            echo "✅ 已强制修改合并后的AndroidManifest.xml"
          else
            echo "⚠️  未找到合并后的清单文件，尝试在主清单中修改..."
            # 如果找不到，则直接修改主项目的清单文件
            MAIN_MANIFEST="app/src/main/AndroidManifest.xml"
            if [ -f "$MAIN_MANIFEST" ]; then
              cp "$MAIN_MANIFEST" "${MAIN_MANIFEST}.bak"
              # 确保主清单中有我们需要的 <uses-sdk> 标签
              if ! grep -q "uses-sdk" "$MAIN_MANIFEST"; then
                sed -i 's/<manifest/<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android">\n    <uses-sdk android:minSdkVersion="19" android:targetSdkVersion="22" \/>/' "$MAIN_MANIFEST"
              else
                sed -i 's/android:minSdkVersion="[^"]*"/android:minSdkVersion="19"/g; s/android:targetSdkVersion="[^"]*"/android:targetSdkVersion="22"/g' "$MAIN_MANIFEST"
              fi
              echo "✅ 已修改主AndroidManifest.xml"
            else
              echo "❌ 错误：未找到任何可修改的AndroidManifest.xml文件"
            fi
          fi
      - name: 6. 构建APK (关键步骤)
        run: |
          flutter build apk --debug --target-platform android-arm

      - name: 7. 重命名APK以便识别
        run: |
          cd build/app/outputs/flutter-apk
          mv app-debug.apk PiliPlus_Legacy_Device_Debug.apk
          echo "✅ APK已构建并重命名"

      - name: 8. 上传APK产物
        uses: actions/upload-artifact@v4
        with:
          name: legacy-debug-apk
          path: build/app/outputs/flutter-apk/PiliPlus_Legacy_Device_Debug.apk
          retention-days: 7
