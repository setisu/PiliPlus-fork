name: Build Legacy APK for Old Projector

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  build:
    name: Build APK (minSdk 19)
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. 安装指定版本 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml
          cache: true

      - name: 4. 应用底部弹窗补丁 (可选)
        working-directory: ${{ env.FLUTTER_ROOT }}
        run: git apply $GITHUB_WORKSPACE/lib/scripts/bottom_sheet_patch.diff
        continue-on-error: true

      - name: 5. 获取依赖 & 应用配置
        run: |
          flutter clean
          flutter pub get

      # ========== 新增的关键步骤 ==========
      - name: 5.5 强制覆盖所有插件的SDK版本（完整配置版）
        run: |
          # 进入android目录，创建/覆盖gradle.properties文件
          cd android
          # 将以下完整配置写入文件，确保格式正确
          cat > gradle.properties << EOF
          # 启用AndroidX和Jetifier（两者必须同时启用）
          android.useAndroidX=true
          android.enableJetifier=true
          # 强制所有模块使用指定的SDK版本（核心目标）
          android.minSdkVersion=19
          android.targetSdkVersion=22
          android.compileSdkVersion=34
          # 可选的性能优化配置
          org.gradle.parallel=true
          org.gradle.daemon=true
          EOF
          echo "✅ 已创建完整的gradle.properties，已启用AndroidX并强制SDK版本为19/22/34"
      # ==================================

      - name: 6. 构建APK (关键步骤)
        run: |
          flutter build apk --debug --target-platform android-arm

      - name: 7. 重命名APK以便识别
        run: |
          cd build/app/outputs/flutter-apk
          mv app-debug.apk PiliPlus_Legacy_Device_Debug.apk
          echo "✅ APK已构建并重命名"

      - name: 8. 上传APK产物
        uses: actions/upload-artifact@v4
        with:
          name: legacy-debug-apk
          path: build/app/outputs/flutter-apk/PiliPlus_Legacy_Device_Debug.apk
          retention-days: 7
