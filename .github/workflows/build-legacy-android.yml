name: Build Legacy APK for Old Projector

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  build:
    name: Build APK (minSdk 19)
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. 安装指定版本 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml
          cache: true

      - name: 4. 应用底部弹窗补丁 (可选)
        working-directory: ${{ env.FLUTTER_ROOT }}
        run: git apply $GITHUB_WORKSPACE/lib/scripts/bottom_sheet_patch.diff
        continue-on-error: true

      - name: 5. 获取依赖 & 应用配置
        run: |
          flutter clean
          flutter pub get

      # ========== 新增的关键步骤 ==========
      - name: 5.5 优化Gradle配置并强制SDK版本
        run: |
          cd android
          cat > gradle.properties << 'EOF'
          # 核心：强制SDK版本以兼容老设备
          android.minSdkVersion=19
          android.targetSdkVersion=22
          android.compileSdkVersion=34
          
          # 启用AndroidX
          android.useAndroidX=true
          android.enableJetifier=true
          
          # ==== 内存与性能优化（解决GC Thrashing）====
          # 为Gradle守护进程分配更大内存
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          # 启用并行构建和配置缓存
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          # 启用Gradle守护进程（加快重复构建）
          org.gradle.daemon=true
          EOF
          echo "✅ 已配置优化后的gradle.properties（含大内存设置）"
      # ==================================

      - name: 6. 构建APK (关键步骤)
        run: |
          flutter build apk --debug --target-platform android-arm

      - name: 7. 重命名APK以便识别
        run: |
          cd build/app/outputs/flutter-apk
          mv app-debug.apk PiliPlus_Legacy_Device_Debug.apk
          echo "✅ APK已构建并重命名"

      - name: 8. 上传APK产物
        uses: actions/upload-artifact@v4
        with:
          name: legacy-debug-apk
          path: build/app/outputs/flutter-apk/PiliPlus_Legacy_Device_Debug.apk
          retention-days: 7
